library(knitr)
knit_with_parameters('~/ownCloud/Documents/GitHub/FemaleDominanceReproduction_MetaAnalysis/Preregistration_MetaAnalysis_RankSuccess.Rmd')
library(metafor)
library(ape)
library(geiger)
library(dplyr)
library(readr)
# For the actual analyses, we will use the full data file
# Load input data from GitHub
inputdata<-read_csv(url("https://raw.githubusercontent.com/dieterlukas/FemaleDominanceReproduction_MetaAnalysis/master/InputData_MetaAnalysis_FemaleDominanceReproduction_March2020.csv"))
inputdata<-data.frame(inputdata)
# For the actual analyses, we will use the full data file
# Load input data from GitHub
inputdata<-read_csv(url("https://raw.githubusercontent.com/dieterlukas/FemaleDominanceReproduction_MetaAnalysis/master/InputData_MetaAnalysis_FemaleDominanceReproduction.csv"))
inputdata<-data.frame(inputdata)
dat<-inputdata
colnames(dat)
#The consensus tree for the 86 species in the actual dataset
mammaltree<-read.nexus(url("https://raw.githubusercontent.com/dieterlukas/FemaleDominanceReproduction_MetaAnalysis/trunk/CombinedTree_MetaAnalysis_RankSuccess.nex"))
library(rethinking)
library(ape)
library(geiger)
#If some variables end up having missing data, we will filter these cases out before any analysis
dstan <- dat[ complete.cases(dat$Rank_Cont_Cat,dat$GroupSize),]
#A non-phylogenetic model to determine the overall effect size
#We create the structured data file for the model
dat_list_simple <- list(
N_spp = nrow(dstan),
Z_obs = dstan$Fishers_Z_r,
Z_sd = dstan$Variance
)
#We run the model assuming that the sampling variance reflects an error in the measurements of the true effect sizes
rethinking_simple <- ulam(
alist(
Z_obs ~dnorm ( Z_true , Z_sd),
vector[N_spp]:Z_true ~ dnorm( mu , sigma_sq ),
mu ~ normal(0,1),
sigma_sq~dexp(1)
),data=dat_list_simple)
precis(rethinking_simple)
#A non-phylogenetic model to determine the influence of group size on the variation in effect sizes
#We create the structured data file for the model
dat_list_groupsize <- list(
N_spp = nrow(dstan),
Z_obs = dstan$Fishers_Z_r,
Z_sd = dstan$Variance,
G = standardize(standardize(log(dstan$GroupSize)))
)
#We run the model
rethinking_groupsize <- ulam(
alist(
Z_obs ~dnorm ( Z_true , Z_sd),
vector[N_spp]:Z_true ~ dnorm( mu , sigma_sq ),
mu <- a+bG*G,
a~normal(0,1),
bG~normal(0,0.5),
sigma_sq~dexp(1)
),data=dat_list_groupsize)
precis(rethinking_groupsize)
#Next we prepare for the phylogenetic models
# We again match the species in the dataset to the phylogenetic tree
spp_obs<-unique(dstan$Latin)
spp_obs<-matrix(nrow=length(spp_obs))
rownames(spp_obs)<-unique(dstan$Latin)
missing<-treedata(mammaltree,data=spp_obs,warnings=FALSE)
mtree<-missing$phy
speciesnames<-mtree$tip.label
mdata<-dstan[dstan$Latin %in% speciesnames,]
#Next, we convert the phylogeny into a covariance matrix that reflects the shared phylogenetic history among all pairs of species in the sample
#There are two approaches: first assuming a Brownian Motion model of evolution, and next a model that includes the parameter Pagel's lambda to account for potential changes in the rate of evolution
Rbm<-corBrownian( phy = mtree )
Rlambda<-corPagel(0.75,phy=mtree,fixed=FALSE)
VCV_bm <- vcv(Rbm)
VCV_pagel<-vcv(Rlambda)
#example model to test for the influence of group size on effect sizes
dat_list <- list(
N_spp = nrow(mdata),
Z_obs = mdata$Fishers_Z_r,
Z_sd = mdata$Variance,
G = standardize(standardize(log(mdata$GroupSize)))
)
#The shared phylogenetic history between pairs of species is reflected in a covariance matrix
#The covariance matrix is standardized by the maximum distance from the shared common ancestor to the tips
#The diagonals (comparison of a population with itself) therefore has the value 1
#Two species that are in separate lineages that split off at the very first node after the common ancestor have entries of 0 in the matrix
#In meta-analyses, we usuallyhave repeated observations from the same species.
#In this model, we assume that all of these to have the same expected similarity of 0.99. That is, we do not further differentiate whether observations come from the same or from different populations.
dat_list$V <- VCV_bm[ mdata$Latin,mdata$Latin ]
dat_list$R <-dat_list$V / max(VCV_bm)
dat_list$R<-dat_list$R*0.99
diag(dat_list$R)<-1
#We run the model.
rethinking_phylogenetic_groupsize <- ulam(
alist(
Z_obs ~dnorm ( Z_true , Z_sd),
vector[N_spp]:Z_true ~ multi_normal( mu , SIGMA ),
mu <- a+bG*G,
matrix[N_spp,N_spp]: SIGMA <- R * sigma_sq,
a~normal(0,1),
bG~normal(0,0.5),
sigma_sq~exponential(1)
),data=dat_list)
#For the simulated data, there is no phylogenetic effect. Accordingly, model indicates a large error for the species-level estimates: they are supposed to be more similar than they actually are.
precis(rethinking_phylogenetic_groupsize)
